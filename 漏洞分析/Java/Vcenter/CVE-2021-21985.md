# CVE-2021-21985

## 原理

h5-vsan 相关的 bundle 提供了一些 API 端点，并且未经过授权即可访问。通过进一步的利用，发现其中某个端点存在安全问题，可以执行任意 Spring Bean 的方法，从而导致命令执行.



未授权接口获取用户提交的Bean类和方法名称,从POST中获取方法参数,在后续进行简单反序列化后直接进行了调用,其中包含一一些可以调用的危险Bean

### vmodlContext

对应的类是 `com.vmware.vim.vmomi.core.types.impl.VmodContextImpl`,`LoadVmodlPackage` 会调用 `SpringContextLoader` 进行加载，`vmodPackage` 可控,最终会调用到 `ClassPathXmlApplicationContext` 的构造方法。`ClassPathXmlApplicationContext` 可以指定一个 XML 文件路径，Spring 会解析 XML 的内容，造成 SpEL 注入，从而实现执行任意代码。在 `SpringContextLoader` 的 `getContextFileNameForPackage` 会将路径中的 `.` 替换为 `/`，所以无法指定一个正常的 IPv4 地址，但是可以利用数字型 IP 绕过：

### 不出网

利用 `vSAN Health` 组件中的 `VsanHttpProvider.py`的SSRF漏洞.

## 参考

http://noahblog.360.cn/vcenter-cve-2021-2021-21985/